{% extends 'dogovornoy/base.html' %}
{% load static %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ —Ç—Ä–µ–≤–æ–≥</title>
<!--    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCovvmKT5mMlAJHdoJ8ImzQEpALjeWUjz4&loading=async"></script>-->
<!--    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" defer></script>-->
<!--    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=marker&callback=initMap"></script>-->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Vue -->
</head>
<body>
    <div id="app">
        <h1>–ö–∞—Ä—Ç–∞ —Ç—Ä–µ–≤–æ–≥ —Ç–µ—Å—Ç19</h1>
        <div id="map" style="width: 100%; height: 500px;"></div>
    </div>

<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=marker&callback=initMap"></script>

<script>
    let map;
    let markers = {};

    function initMap() {
        console.log("Google Maps API –∑–∞–≥—Ä—É–∂–µ–Ω!");

        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 43.2567, lng: 76.9286 }, // –ê–ª–º–∞—Ç—ã
            zoom: 12,
        });

        loadAlarms();  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–µ–≤–æ–≥–∏ –∏–∑ API
    }

    function loadAlarms() {
        const apiToken = "{{ user_api_token }}";

        fetch('/api/panicbutton/get_alarms/', {
            headers: { "Authorization": `Token ${apiToken}` }
        })
        .then(response => response.json())
        .then(data => {
            if (!Array.isArray(data)) {
                console.error("–û—à–∏–±–∫–∞: –ø–æ–ª—É—á–µ–Ω—ã –Ω–µ –º–∞—Å—Å–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", data);
                return;
            }

            data.forEach(alarm => addMarker(alarm));
        })
        .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–≤–æ–≥:", error));
    }

    function addMarker(alarm) {
        if (markers[alarm.id]) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä–∫–µ—Ä

        const marker = new google.maps.Marker({
            position: { lat: parseFloat(alarm.latitude), lng: parseFloat(alarm.longitude) },
            map: map,
            title: `–¢—Ä–µ–≤–æ–≥–∞ –æ—Ç ${alarm.client_name}`,
            animation: google.maps.Animation.DROP  // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        });

        markers[alarm.id] = marker; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ —Å–ø–∏—Å–æ–∫
    }

    // === WebSocket ===
    const socket = new WebSocket("wss://kateryushin.pro/ws/");

    socket.onopen = function() {
        console.log("üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ WebSocket —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!");
    };

    let alarmAudio = new Audio('/static/sounds/alarm.mp3');

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);

        console.log("üö® –ù–æ–≤–∞—è —Ç—Ä–µ–≤–æ–≥–∞:", data);

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ —Ç—Ä–µ–≤–æ–≥–∏
        alarmAudio.play().catch(error => {
            console.warn("üö® –ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∞—É–¥–∏–æ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é.");
        });

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–≤–æ–≥—É –Ω–∞ –∫–∞—Ä—Ç—É
        addMarker(data);
    };

    socket.onerror = function(error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ WebSocket:", error);
    };

    socket.onclose = function(event) {
        console.warn("üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ WebSocket –∑–∞–∫—Ä—ã—Ç–æ:", event);
    };

</script>
</body>
{% endblock %}