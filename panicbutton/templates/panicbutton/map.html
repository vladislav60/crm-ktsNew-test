{% extends 'dogovornoy/base.html' %}
{% load static %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ —Ç—Ä–µ–≤–æ–≥</title>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&loading=async"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Vue -->
</head>
<body>
    <div id="app">
        <h1>–ö–∞—Ä—Ç–∞ —Ç—Ä–µ–≤–æ–≥ —Ç–µ—Å—Ç4</h1>
        <div id="map" style="width: 100%; height: 500px;"></div>
    </div>

<script>
const { createApp, ref, onMounted } = Vue;

createApp({
    setup() {
        const map = ref(null);
        const markers = ref({});  // –•—Ä–∞–Ω–∏–º –º–∞—Ä–∫–µ—Ä—ã –ø–æ ID —Ç—Ä–µ–≤–æ–≥–∏

        function initMap() {
            map.value = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 43.238255, lng: 76.94987 },
                zoom: 12
            });

            loadAlarms(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–µ–≤–æ–≥–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            setupWebSocket(); // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
        }

        function loadAlarms() {
            fetch('/api/panicbutton/get_alarms/', {
                headers: { "Authorization": "Token 2a409ae8dd2d6dadd56d889a212d6df75d26a182" }
            })
            .then(response => response.json())
            .then(data => {
                data.forEach(alarm => addMarker(alarm));
            });
        }

        function addMarker(alarm) {
            if (markers.value[alarm.id]) return;  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä–∫–µ—Ä

            const marker = new google.maps.Marker({
                position: { lat: parseFloat(alarm.latitude), lng: parseFloat(alarm.longitude) },
                map: map.value,
                title: `–¢—Ä–µ–≤–æ–≥–∞ –æ—Ç ${alarm.client_name}`,
                animation: google.maps.Animation.DROP  // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
            });

            markers.value[alarm.id] = marker;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ —Å–ø–∏—Å–æ–∫
        }

        function setupWebSocket() {
            const socket = new WebSocket("wss://127.0.0.1:8000/ws/alarms/");

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log("üö® –ù–æ–≤–∞—è —Ç—Ä–µ–≤–æ–≥–∞:", data);

                addMarker(data);  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

                playSiren();  // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —Ç—Ä–µ–≤–æ–≥–∏
            };

            socket.onerror = function(error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ WebSocket:", error);
            };

            socket.onclose = function(event) {
                console.warn("üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ:", event);
            };
        }

        function playSiren() {
            const audio = new Audio('/static/sounds/alarm.mp3');
            audio.play().catch(error => console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ:", error));
        }

        onMounted(initMap);

        return { map, markers };
    }
}).mount("#app");
</script>
</body>
{% endblock %}