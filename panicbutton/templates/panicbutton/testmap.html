{% extends 'dogovornoy/base.html' %}
{% load static %}

{% block content %}
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" defer></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
<body>
    <h1>–ö–∞—Ä—Ç–∞ —Ç—Ä–µ–≤–æ–≥</h1>

    <div id="map"></div>

    <script>
        function initMap() {
            const map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 43.2567, lng: 76.9286 }, // –ê–ª–º–∞—Ç—ã
                zoom: 12,
            });

            const apiToken = "{{ user_api_token }}";
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–µ–≤–æ–≥–∏ —á–µ—Ä–µ–∑ API
            fetch('/api/panicbutton/get_alarms/', {
                headers: { "Authorization": `Token ${apiToken}` }
            })
            .then(response => response.json())
            .then(data => {
            if (!Array.isArray(data)) {
                console.error("–û—à–∏–±–∫–∞: –ø–æ–ª—É—á–µ–Ω—ã –Ω–µ –º–∞—Å—Å–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", data);
                return;
            }

            data.forEach(alarm => {
                new google.maps.Marker({
                    position: { lat: alarm.latitude, lng: alarm.longitude },
                    map,
                    title: `–¢—Ä–µ–≤–æ–≥–∞: ${alarm.client_name}`,
                });
            });
        })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–≤–æ–≥:", error));
        }


        const socket = new WebSocket("wss://kateryushin.pro/ws/alarms/");

        socket.onopen = function() {
            console.log("üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!");
        };

        let alarmAudio = new Audio('/static/sounds/alarm.mp3');

        function enableSound() {
            alarmAudio.play();
            console.log("üîä –ê—É–¥–∏–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º");
        }

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            alarmAudio.play().catch(error => {
                console.warn("üö® –ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∞—É–¥–∏–æ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é.");
            });
            console.log("–í–∫–ª—é—á–∞–µ–º –∑–≤—É–∫");
            console.log("üö® –ù–æ–≤–∞—è —Ç—Ä–µ–≤–æ–≥–∞:", data);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–≤–æ–≥—É –Ω–∞ –∫–∞—Ä—Ç—É
            addMarker(data.latitude, data.longitude, `–¢—Ä–µ–≤–æ–≥–∞ –æ—Ç ${data.client_name}`);
        };

        socket.onerror = function(error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ WebSocket:", error);
        };

        socket.onclose = function(event) {
            console.warn("üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ:", event);
        };

    </script>
</body>
{% endblock %}